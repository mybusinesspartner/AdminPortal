<div class="tickets-container">
  <header class="tickets-header">
    <div class="header-content">
      <button class="back-button" (click)="goBack()">← Back to Dashboard</button>
      <h1>Support Tickets</h1>
      <button class="logout-button" (click)="logout()">
        <svg class="logout-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        Logout
      </button>
    </div>
  </header>

  <main class="tickets-main">
    <div class="tabs-container">
      <div class="tabs">
        <button
          class="tab-button all"
          [class.active]="activeTab === 'all'"
          (click)="switchTab('all')"
        >
          <svg class="tab-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="9" y1="3" x2="9" y2="21"></line>
            <line x1="3" y1="9" x2="21" y2="9"></line>
          </svg>
          <span>All</span>
          <span class="tab-count" *ngIf="counts.all > 0">{{ counts.all }}</span>
        </button>
        <button
          class="tab-button open"
          [class.active]="activeTab === 'open'"
          (click)="switchTab('open')"
        >
          <svg class="tab-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <span>Open</span>
          <span class="tab-count" *ngIf="counts.open > 0">{{ counts.open }}</span>
        </button>
        <button
          class="tab-button in_progress"
          [class.active]="activeTab === 'in_progress'"
          (click)="switchTab('in_progress')"
        >
          <svg class="tab-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          <span>In Progress</span>
          <span class="tab-count" *ngIf="counts.in_progress > 0">{{ counts.in_progress }}</span>
        </button>
        <button
          class="tab-button resolved"
          [class.active]="activeTab === 'resolved'"
          (click)="switchTab('resolved')"
        >
          <svg class="tab-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          <span>Resolved</span>
          <span class="tab-count" *ngIf="counts.resolved > 0">{{ counts.resolved }}</span>
        </button>
        <button
          class="tab-button closed"
          [class.active]="activeTab === 'closed'"
          (click)="switchTab('closed')"
        >
          <svg class="tab-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          <span>Closed</span>
          <span class="tab-count" *ngIf="counts.closed > 0">{{ counts.closed }}</span>
        </button>
      </div>
    </div>

    <div class="filters-section">
      <div class="search-box">
        <input
          type="text"
          placeholder="Search tickets by subject, description, user name, or email..."
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
          class="search-input"
        />
      </div>

      <div class="filter-controls">
        <div class="filter-group">
          <label>Category:</label>
          <select [(ngModel)]="selectedCategory" (change)="onCategoryChange()" class="filter-select">
            <option value="all">All Categories</option>
            <option value="Getting Started">Getting Started</option>
            <option value="Billing and Subscription">Billing and Subscription</option>
            <option value="Messaging and Communication">Messaging and Communication</option>
            <option value="Privacy and Security">Privacy and Security</option>
            <option value="Safety">Safety</option>
            <option value="Success Stories and Testimonials">Success Stories and Testimonials</option>
            <option value="Feedback and Suggestions">Feedback and Suggestions</option>
            <option value="Forgot Password">Forgot Password</option>
            <option value="Documentation Upload">Documentation Upload</option>
            <option value="Technical Issue">Technical Issue</option>
            <option value="Others">Others</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Business Type:</label>
          <select [(ngModel)]="selectedBusinessType" (change)="onBusinessTypeChange()" class="filter-select">
            <option value="all">All Business Types</option>
            <option value="Corporate Business">Corporate Business</option>
            <option value="Local Business">Local Business</option>
          </select>
        </div>
      </div>
    </div>

    <div class="tickets-list" *ngIf="!isLoading">
      <div
        *ngFor="let ticket of paginatedTickets"
        class="ticket-card"
        (click)="viewTicket(ticket.id)"
      >
        <div class="ticket-header">
          <div class="ticket-id">#{{ ticket.id }}</div>
          <div class="ticket-badges">
            <span class="badge" [ngClass]="getStatusClass(ticket.status)">
              {{ ticket.status.replace('_', ' ') }}
            </span>
            <span class="badge" [ngClass]="getCategoryClass(ticket.category)">
              {{ ticket.category }}
            </span>
          </div>
        </div>

        <div class="ticket-content">
          <h3 class="ticket-subject">{{ ticket.subject }}</h3>
          <p class="ticket-description">{{ ticket.description }}</p>
        </div>

        <div class="ticket-footer">
          <div class="ticket-user">
            <span class="user-name">{{ ticket.userName }}</span>
            <span class="user-email">{{ ticket.userEmail }}</span>
          </div>
          <div class="ticket-meta">
            <span class="business-type" [ngClass]="getBusinessTypeBadgeClass(ticket.businessType)">
              {{ ticket.businessType }}
            </span>
            <span class="ticket-date">{{ ticket.createdAt | date:'short' }}</span>
            <span class="comment-count" *ngIf="ticket.comments && ticket.comments.length > 0">
              {{ ticket.comments.length }} comment(s)
            </span>
          </div>
        </div>
      </div>

      <div class="no-tickets" *ngIf="filteredTickets.length === 0">
        <p>No tickets found matching your criteria.</p>
      </div>

      <!-- Pagination Controls -->
      <div class="pagination-container" *ngIf="filteredTickets.length > 0 && !isLoading">
        <div class="pagination-info">
          <span>
            Showing {{ (currentPage - 1) * itemsPerPage + 1 }} -
            {{ getMin(currentPage * itemsPerPage, filteredTickets.length) }}
            of {{ filteredTickets.length }} tickets
          </span>
        </div>
        <div class="pagination-controls-wrapper">
          <div class="page-size-selector">
            <label for="pageSize">Items per page:</label>
            <select
              id="pageSize"
              [(ngModel)]="itemsPerPage"
              (change)="onPageSizeChange()"
              class="page-size-select"
            >
              <option *ngFor="let size of pageSizeOptions" [value]="size">
                {{ size }}
              </option>
            </select>
          </div>
          <div class="pagination-controls">
            <button
              class="pagination-button"
              [disabled]="currentPage === 1"
              (click)="previousPage()"
              aria-label="Previous page"
            >
              ‹ Previous
            </button>

            <div class="page-numbers">
              <button
                *ngFor="let page of getPageNumbers()"
                class="page-number"
                [class.active]="page === currentPage"
                (click)="goToPage(page)"
              >
                {{ page }}
              </button>
            </div>

            <button
              class="pagination-button"
              [disabled]="currentPage === totalPages"
              (click)="nextPage()"
              aria-label="Next page"
            >
              Next ›
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="loading-state" *ngIf="isLoading">
      <div class="spinner"></div>
      <p>Loading tickets...</p>
    </div>
  </main>
</div>

